<!DOCTYPE html>
<html>
<head>
    <title>自訂 YouTube 字幕播放器</title>
    <style>
        /* --- 基礎樣式 (暗色系) --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background-color: #121212; color: #e0e0e0; margin: 0; }
        #container { max-width: 800px; margin: auto; background-color: #1e1e1e; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, .5); border: 1px solid #333; transition: max-width 0.3s ease; }
        h1 { color: #fff; text-align: left; border-bottom: 1px solid #444; padding-bottom: 15px; margin-top: 0; min-height: 1.2em; font-size: 1.5em; }
        
        /* --- 播放器容器樣式 --- */
        #player-container {
            margin-top: 20px;
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background-color: #000;
            width: 100%;
            aspect-ratio: 16 / 9;
            transition: height 0.4s ease-in-out;
        }
        #player { width: 100%; height: 100%; }
        
        /* --- 符合高度模式 --- */
        #player-container.fit-height { height: 75vh; aspect-ratio: auto; }

        /* --- 尺寸控制按鈕 --- */
        #size-controls { margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px; }
        #size-controls button { width: auto; padding: 8px 16px; font-size: 0.9em; background-color: #3e3e3e; }
        #size-controls button:hover { background-color: #555; }
        
        #subtitle-container { margin-top: 15px; padding: 20px; background-color: #000; color: #fff; border-radius: 8px; min-height: 60px; font-size: 1.6em; text-align: center; line-height: 1.4; font-weight: 700; text-shadow: 1px 1px 3px rgba(0, 0, 0, .7); }
        #offset-controls { margin-top: 20px; padding-top: 15px; border-top: 1px solid #444; display: flex; align-items: center; justify-content: center; gap: 12px; }
        #offset-controls button { width: 50px; font-size: 1.2em; background-color: #3e3e3e; }
        #offset-controls button:hover { background-color: #555; }
        #offset-value { font-size: 1.1em; font-weight: 700; min-width: 120px; text-align: center; color: #fff; }
        
        #download-container { margin-top: 15px; text-align: right; }
        #download-srt-button { width: auto; padding: 10px 20px; background-color: #28a745; }
        #download-srt-button:hover { background-color: #218838; }

        /* --- 自訂全螢幕模式的關鍵樣式 --- */
        body.custom-fullscreen {
            overflow: hidden;
        }
        
        body.custom-fullscreen #container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            max-width: 100%;
            z-index: 1000;
            padding: 10px;
            box-sizing: border-box;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            flex-direction: column; 
        }

        body.custom-fullscreen #player-container {
            flex-grow: 1; 
            height: 0;
            margin-top: 10px;
            aspect-ratio: auto;
        }
        
        body.custom-fullscreen h1 { flex-shrink: 0; padding-bottom: 10px; border: none; }
        body.custom-fullscreen #subtitle-container { 
            flex-shrink: 0;
            font-size: 2em;
        }

        body.custom-fullscreen #offset-controls,
        body.custom-fullscreen #download-container,
        body.custom-fullscreen #size-controls {
            display: none;
        }
    </style>
</head>
<body>

<div id="container">
    <h1 id="video-title">載入中...</h1>

    <div id="player-container">
        <div id="player"></div>
    </div>

    <div id="size-controls">
        <button id="fit-height-btn" onclick="toggleFitHeight()">符合高度</button>
        <button id="fullscreen-btn" onclick="toggleFullScreen()">全螢幕</button>
    </div>
    
    <div id="subtitle-container">請稍候，正在從網址參數載入影片與字幕...</div>
    
    <div id="offset-controls">
        <button onclick="adjustOffset(-0.1)">-</button>
        <span id="offset-value">偏移: 0.0 s</span>
        <button onclick="adjustOffset(0.1)">+</button>
    </div>

    <div id="download-container" style="display: none;">
        <button id="download-srt-button" onclick="downloadSubtitles()">下載字幕 (.srt)</button>
    </div>
</div>

<script>
    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player, subtitles = [], isPlayerPlaying = false, subtitleOffset = 0;
    var rawSrtContent = ''; 

    function toggleFitHeight() {
        if (document.body.classList.contains('custom-fullscreen')) {
            toggleFullScreen();
            return;
        }
        document.getElementById('player-container').classList.toggle('fit-height');
        updateSizeControlButtonText();
    }

    function toggleFullScreen() {
        document.body.classList.toggle('custom-fullscreen');
        const isFullScreen = document.body.classList.contains('custom-fullscreen');
        
        // 進入全螢幕時，確保版型是 fit-height，這樣退出時才會是期望的版型
        if (isFullScreen) {
            document.getElementById('player-container').classList.add('fit-height');
        }
        updateSizeControlButtonText();
    }
    
    function updateSizeControlButtonText() {
        const fitHeightBtn = document.getElementById('fit-height-btn');
        const playerContainer = document.getElementById('player-container');

        if (playerContainer.classList.contains('fit-height')) {
            fitHeightBtn.innerText = '恢復原始';
        } else {
            fitHeightBtn.innerText = '符合高度';
        }
    }
    
    window.addEventListener('keydown', function(event) {
        if (event.key === 'Escape' && document.body.classList.contains('custom-fullscreen')) {
            toggleFullScreen();
        }
    });

    function onYouTubeIframeAPIReady(){
        console.log("YouTube API is ready.");
        loadDataFromUrl();
        requestAnimationFrame(subtitleLoop);
    }
    
    async function loadDataFromUrl() {
        const params = new URLSearchParams(window.location.search);
        const youtubeUrl = params.get('youtubeUrl');
        const subtitleUrl = params.get('subtitleUrl'); 

        if (!youtubeUrl) {
            document.getElementById('video-title').innerText = "錯誤";
            document.getElementById('subtitle-container').innerText = "缺少 'youtubeUrl' 網址參數。";
            return;
        }
        
        const videoId = parseVideoID(youtubeUrl);
        if (videoId) {
            loadVideoFromId(videoId);
        } else {
            document.getElementById('video-title').innerText = "錯誤";
            document.getElementById('subtitle-container').innerText = "無效的 YouTube 網址。";
            return;
        }

        if (!subtitleUrl) {
            document.getElementById('subtitle-container').innerText = "影片已載入，但缺少 'subtitleUrl' 字幕網址參數。";
            return;
        }

        try {
            const response = await fetch(subtitleUrl); 
            if (!response.ok) throw new Error(`無法下載字幕 (HTTP ${response.status})`);
            rawSrtContent = await response.text();
            subtitles = parseSRT(rawSrtContent);
            document.getElementById('subtitle-container').innerText = "字幕已載入，請播放影片。";
            document.getElementById('download-container').style.display = 'block';
        } catch (error) {
            console.error("從 URL 載入字幕失敗:", error);
            document.getElementById('subtitle-container').innerText = "自動載入字幕失敗，請檢查連結。\n錯誤訊息: " + error.message;
        }
    }
    
    function onPlayerReady(event) {
        document.getElementById('video-title').innerText = event.target.getVideoData().title || "自訂 YouTube 字幕播放器";
    }

    function downloadSubtitles() {
        if (!rawSrtContent) {
            alert("沒有可下載的字幕內容。");
            return;
        }
        
        let fileName = "subtitles.srt";
        if (player && player.getVideoData) {
            const videoTitle = player.getVideoData().title;
            if (videoTitle) {
                fileName = videoTitle.replace(/[\\?%*:|"<>]/g, '_') + '.srt';
            }
        }

        const blob = new Blob([rawSrtContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    }

    function subtitleLoop() {
        if (isPlayerPlaying) {
            updateSubtitle();
        }
        requestAnimationFrame(subtitleLoop);
    }

    function onPlayerStateChange(event) {
        isPlayerPlaying = (event.data == YT.PlayerState.PLAYING);
    }

    function updateSubtitle() {
        if (!player || typeof player.getCurrentTime !== 'function' || subtitles.length === 0) return;
        
        const currentTime = player.getCurrentTime() + subtitleOffset;
        const subtitleDisplay = document.getElementById('subtitle-container');
        let currentSubtitle = subtitles.find(sub => currentTime >= sub.start && currentTime <= sub.end);
        
        subtitleDisplay.innerHTML = currentSubtitle ? currentSubtitle.text.replace(/\n/g, "<br>") : "&nbsp;"; 
    }

    function adjustOffset(amount) {
        subtitleOffset += amount;
        document.getElementById('offset-value').innerText = `偏移: ${subtitleOffset.toFixed(1)} s`;
        updateSubtitle();
    }
    
    function loadVideoFromId(videoId) {
        if (player) {
            player.loadVideoById(videoId);
        } else {
            player = new YT.Player("player", {
                videoId: videoId,
                // --- 【關鍵修改】在這裡加入參數 ---
                playerVars: {
                    'playsinline': 1, // 在手機上於頁內播放
                    'fs': 0           // 停用 YouTube 播放器內建的全螢幕按鈕
                },
                events: { 
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange 
                }
            });
        }
    }
    
    function parseVideoID(url) {
        const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/|youtube\.com\/shorts\/)([a-zA-Z0-9_-]{11})/;
        const match = url.match(regex);
        return match ? match[1] : null;
    }
    
    function parseSRT(data) {
        let text = data.trim();
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        
        const blocks = text.split('\n\n');
        const result = [];
        const timeRegex = /(\d{2}:\d{2}:\d{2}[,.]\d{3})\s*-->\s*(\d{2}:\d{2}:\d{2}[,.]\d{3})/;

        function timeToSeconds(time) {
            const t = time.replace(',', '.');
            const parts = t.split(':');
            try {
                const seconds = parseFloat(parts[2]);
                return parseInt(parts[0], 10) * 3600 + parseInt(parts[1], 10) * 60 + seconds;
            } catch (e) { return 0; }
        }

        for (const block of blocks) {
            const lines = block.split('\n');
            if (lines.length < 2) continue;

            let timeLineIndex = lines.findIndex(line => timeRegex.test(line));

            if (timeLineIndex !== -1) {
                const timeMatch = lines[timeLineIndex].match(timeRegex);
                const startTime = timeToSeconds(timeMatch[1]);
                const endTime = timeToSeconds(timeMatch[2]);
                const subtitleText = lines.slice(timeLineIndex + 1).join('\n').trim();

                if (!isNaN(startTime) && !isNaN(endTime) && subtitleText) {
                    result.push({ start: startTime, end: endTime, text: subtitleText });
                }
            }
        }
        
        console.log(`字幕解析完成！總共成功載入 ${result.length} 句字幕。`);
        return result;
    }
</script>

</body>
</html>
